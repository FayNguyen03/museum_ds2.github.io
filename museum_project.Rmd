---
title: "Museums"
output:
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bg: '#101010'
      fg: white
      primary: '#9d5c63'
runtime: shiny
resource_files:
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.sbx
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.shx
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.sbn
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.dbf
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.shx
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.shp
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.sbx
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.sbn
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.dbf
- Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.shp.xml
---

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggspatial)
library(sf)
library(ggthemes)
library(dplyr)
library(cdlTools)
library(ggrepel)
library(gghighlight)
library(beepr)
library(tigris)
library(spData)
data(us_states)
library(raster)
library(tmap)
library(shiny)
library(flexdashboard)
library(spatialreg)
library(spdep)
library(plotly)
library(flexdashboard)
library(tm)
library(ggplot2)

museums <- read_csv("Data/museums_tidy.csv") 
museums_sf <- museums |> filter(!is.na(LONGITUDE)) |> filter(!is.na(LATITUDE)) |>  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), remove = FALSE) |> st_set_crs(4326) |> st_transform(4269)
mn_sf <- st_read("Data/shp_bdry_counties_in_minnesota/mn_county_boundaries.shp") |> st_transform(4326)

counties <- st_read("Data/cb_2023_us_county_5m/cb_2023_us_county_5m.shp") |>
  # as.data.frame() |> 
  mutate(
    ADSTATE = fips(STATEFP, to = 'Abbreviation')
  )

us_states <- us_states |> 
  mutate(
    ADSTATE = fips(GEOID, to = "Abbreviation")
  )

minneseum <- read_csv("Data/tripadvisor_data.csv")
```

# About

## Column {data-width = 200}

**Introduction**

![](img/museum1.jpg)

Food deserts are areas with limited to no access to nutrition. There have been many analyses of the food disparity globally and nationally, even manifesting in developed urban spaces like Chicago. Analyses have found an intimate relationship between food disparities and race.


Being inspired by these accounts, we were curious to see if there was such a thing as a museum desert. While they are not as essential as food, museums offer important educational information as well as being sources of entertainment. This is important as museums can offer insights from disciplines outside of oneâ€™s usual pursuits, offer a more specialised investigation of a certain topic, or provide information that are excluded by institutional bias.

This project aims to explore the diversity and quantity of museums in the United States, in an attempt to visualise trends in spatial distribution, discipline, and museum-goers' experiences.

**Data set Information**

We mainly focus on the dataset from [IMLS](https://www.imls.gov/research-evaluation/data-collection/museum-data-files). There are 7 categories of museums regulated by the IMLS, represented by the `DISCIPLINE` with each code corresponding to a specific category. Besides, we attempted fetching data from the TripAdvisorAPI to gain more information from the tourist perspective.

| CODE | DISCIPLINE                                  |
|------|---------------------------------------------|
| ART  | Art Museums                                 |
| CMU  | Children Museums                            |
| HST  | History Museums                             |
| NAT  | Natural History & Natural Science Museums   |
| SCI  | Science & Technology Museums & Planetariums |
| GMU  | Uncategorized or General Museums            |
| HSC  | Historic Preservation                       |

# Discipline Distribution

## Inputs {.sidebar}

```{r, echo=FALSE}
inputPanel(
  selectInput(inputId = "unit", label = "Unit of Area:",
                choices = c("State", "AAMREG", "BEAREG", "LOCALE4"),
                selected = "State"),
  uiOutput("dynamicInput"),
  dynamicInput <- renderUI({
    areg <- museums$AAMREG[museums$AAMREG!="NA"]
    breg <- museums$BREG[museums$BREG!="NA"]
    local <- museums$LOCALE4[museums$LOCALE4!="NA"]
    if (input$unit == "State") {
      selectInput("state", "State", choices = museums$ADSTATE, selected = "MN")
    } 
    else if (input$unit == "AAMREG") {
      selectInput("aamreg", "AAMREG", choices = c("New England", "Mid-Atlantic", "Southeastern", "Midwest", "Mountain Plains", "Western") , selected = "Midwest")
    } 
    else if (input$unit == "BEAREG") {
      selectInput("beareg", "BEAREG", choices = c("New England", "Mid-East", "Great Lakes", "Plains", "Southest", "Southwest", "Rocky Mountains", "Far West"), selected = "Southest")
    } 
    else if (input$unit == "LOCALE4") {
      selectInput("locale4", "LOCALE4", choices = c("City", "Suburb", "Town", "Rural"), selected = "City")
    }
  })
  
)

```

We can see that in most states, a large portion of museums are categorized as `Historic Preservation` or `General Meseum` while the two types of museums that have the smallest number of organizations are `Children Museum` and `Natural Science Museum`.

When we consider the unit of area as AAMREG (Museum region, regions are determined by AAM) or BEAREG (Bureau of Economic Analysis regions), the type of museums with the largest amount is always `Historic Preservation`. However, when we consider the unit of area as LOCALE4 (NCES Urban-Centric Locale Codes classification), `General Museum` always takes the top 1 in all types of territories. 


## Column


```{r, echo=FALSE}
renderPlot({
  if(input$unit == "State"){
    if (input$state != ""){
      discipline1 <- museums |> filter(ADSTATE == input$state)|>
      group_by(DISCIPLINE) |>
      summarize(n = n()) 
      title1 <- paste(toupper("Discipline Distribution in"),input$state)
    }
    else{
       discipline1 <- museums |>
        group_by(DISCIPLINE) |>
        summarize(n = n()) 
       regions
       title1 <- toupper("Discipline Distribution in the USA")
    }
  }
  else if (input$unit == "AAMREG"){
      aamreg <- c("New England", "Mid-Atlantic", "Southeastern", "Midwest", "Mountain Plains", "Western")
      discipline1 <- museums |> filter(AAMREG == match(aamreg,input$aamreg))|>
      group_by(DISCIPLINE) |>
      summarize(n = n()) 
      title1 <- toupper(paste("Discipline Distribution in",input$aamreg,"region"))
  }
  else if (input$unit == "BEAREG"){
      beareg <- c("New England", "Mid-East", "Great Lakes", "Plains", "Southest", "Southwest", "Rocky Mountains", "Far West")
      discipline1 <- museums |> filter(BEAREG == match(beareg,input$beareg))|>
      group_by(DISCIPLINE) |>
      summarize(n = n()) 
      title1 <- toupper(paste("Discipline Distribution in",input$beareg,"region"))
  }
  else if (input$unit == "LOCALE4"){
      local <- c("City", "Suburb", "Town", "Rural")
      discipline1 <- museums |> filter(LOCALE4 == match(local,input$locale4))|>
      group_by(DISCIPLINE) |>
      summarize(n = n()) 
      title1 <- toupper(paste("Discipline Distribution in",input$locale4,"territories"))
  }
    discipline1|>
      ggplot(aes(x = fct_reorder(DISCIPLINE,n), y = n)) +
      geom_col(aes(fill = DISCIPLINE)) +
      coord_flip(xlim = NULL, ylim = NULL, expand = TRUE, clip = "on")+
      labs(y = "Number of Organizations", x = "Discipline", title = title1) +
      theme_minimal()
})
```


# Nationwide exploration

## Inputs {.sidebar}

```{r, echo=FALSE}
inputPanel(
  selectInput("input_var", label = "Number of museums by:",
              choices = c("State", "Population", "Area"), selected = "State"),
)
  
```

## Column

```{r, echo=FALSE}
renderPlot({
  museums |> 
  count(ADSTATE) |> 
  rename(State = n) |>
  left_join(us_states) |> 
  mutate(
    Population = State / (total_pop_15 / as.numeric(AREA)),
    Area = log(State / as.numeric(AREA)),
  ) |> 
  st_as_sf() |> 
  ggplot() +
  geom_sf(aes_string(fill = input$input_var)) +
    theme_map()
})
```

# State exploration

## Inputs {.sidebar}


```{r, echo=FALSE}
inputPanel({
  selectInput("input_state", label = "State:",
              choices = c(as.character(us_states$ADSTATE)), selected = "MN")
})
```


```{r, echo=FALSE}
  inputPanel(
    selectInput("input_county", label = "County:",
              choices = c("", filter(counties, ADSTATE == "MN")$NAME), selected = "All"),
)
```

```{r, echo = FALSE}
reactive({
          updateSelectInput(session, "input_county", choices = c("", filter(counties, ADSTATE == input$input_state)$NAME), selected = "")
    })

```

## Column

```{r, echo=FALSE}
renderPlot({
  state_var = input$input_state
county_var = input$input_county
state_sf = counties |> 
  filter(ADSTATE == state_var)
if (county_var != "") {
  state_sf = state_sf |> 
    filter(NAME == county_var) 
}
museums_sf |>
  filter(ADSTATE == state_var) |>
  st_intersection(state_sf) |> 
ggplot() +
  geom_sf(data = state_sf) +
  geom_sf(size = 0.1) +
  labs(
    title = str_c("Museums in ", county_var, " ", state_var)
  ) +
  theme_map()
})

beep()
```

```{r, echo=FALSE}
renderPlot({
state_var = input$input_state

counties_sf = counties |>
  filter(ADSTATE == state_var)

state_museums_sf = museums_sf |>
  filter(ADSTATE == state_var)

counties_sf$n = lengths(st_intersects(counties_sf, state_museums_sf))

set.seed(1)
counties_nb <- poly2nb(counties_sf, queen = FALSE)
counties_nbw <- nb2listw(counties_nb, style = "W", zero.policy = TRUE)
ac_stat = moran.mc(counties_sf$n, counties_nbw, nsim = 999)


ggplot(counties_sf) +
  geom_sf(aes(fill = n / ALAND))
})

renderValueBox({
  valueBox(value = ac_stat$statistic)
})
beep()
```


# Explore

```{r echo = FALSE}
# tmap_mode("view")
# museums_sf |>
#   mutate(
#     COMMONNAME = iconv(COMMONNAME, to = "utf-8"),
#     ADSTREET = iconv(ADSTREET, to = "utf-8"),
#     ADCITY = iconv(ADCITY, to = "utf-8"),
#   ) |>
# tm_shape() +
#   tm_dots(col = "DISCIPLINE", alpha = 0.5, size = 0.1, id = "COMMONNAME", popup.vars = c("Website:" = "WEBURL", "Address:" = "ADSTREET", "City:" = "ADCITY", "State:" = "ADSTATE", "ZIP:" = "ADZIP5"))

```

# Minneseums

Since we decided to delve in organizations in Minnesota, we integrated the TripAdvisor API to fetch some data about organizations, combining with the IMLS dataset show when the user is travelling a specific place in MN, they can find the organizations at that location and find valuable information.

```{r, echo = FALSE}
minneseums_sf <- minneseum |> filter(!is.na(lat)) |> filter(!is.na(long)) |>  st_as_sf(coords = c("long", "lat"), remove = FALSE) |> st_set_crs(4326) |> st_transform(4269) |>
  mutate(name = str_replace(name,"<a0>"," "))
```

```{r, echo = FALSE}
library(leaflet)
library(leaflet.extras)

popup_content <- function(name, rate, operation, website_1, address, city, img) {
  img_val <- ifelse(img != FALSE, paste0("<img src=\"", img, "\">"),"")
  rate_val <- ifelse(rate != FALSE, paste0("<p><strong>Rate (TripAdvisor):</strong> ", rate, "</p>"), "<p><strong>Rate (TripAdvisor):</strong> Not Available</p>")
  open_hour_val <- ifelse(operation != FALSE, paste0("<p><strong>Open Hour:</strong> ", operation, "</p>"), "<p>Open Hour: Not Available</p>")
  web_val <- ifelse(website_1 != FALSE, paste0("<a href=\"", website_1, "\">Link</a>"), "<p>Link: Not Available</p>")
  
  popupContent <- mapply(function(name_val, rate_val, open_hour_val, web_val, address_val, city_val, image) {
    paste0(
      img_val,
      "<h2>", name_val, "</h2>",
      "<h4>", address_val, " ",city_val, "</h4>",
      rate_val,
      open_hour_val,
      web_val
      
    )
  }, name, rate_val, open_hour_val, web_val, address, city,img_val)
  
  popupTemplate <- sprintf(
    '<script data-for="leaflet-extras">
    function(uid, html) {
      var popup = L.responsivePopup({hasTip: true, autoPan: true, offset: [15, 12]}).setContent(html);
      return popup;
    }
    </script>%s', popupContent
  )
  
  return(popupTemplate)
}

# Create the Leaflet map
map <- leaflet(data = minneseums_sf) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data = mn_sf, weight = 2, color = "black", fillOpacity = 0) %>%
  addCircleMarkers(
    radius = 5,
    stroke = FALSE,
    fillOpacity = 0.8,
    color = "red",
    labelOptions = labelOptions(noHide = TRUE, direction = "auto"),
    popup = ~popup_content(name, rate, operation, website_1, address, city, image)
  )

map
```

# Limitations

We must be wary of ecological fallacy, as museumgoers in states with relatively little institutions may be more avid attendees. Our analysis does not consider the robustness of exhibitions, frequency of new programs, and the out-of-state proportion of visitors.

Due to the limitation in the number of API calls (5000) allowed for a free subscription plan, we can only fetch the data of the museums in Minnesota. The process is complicated since first we needed to find the `locationId` (a unique identifier for a location on Tripadvisor) among many locations that are similar to our locations of interest. Then we use the ID to fetch the information and image link. There exist some locations that are not available on the TripAdvisor database or the places have not had any reviews or description records.  

![](https://files.readme.io/fab482d-Tripadvisor_lockup_horizontal_secondary_registered.svg)


