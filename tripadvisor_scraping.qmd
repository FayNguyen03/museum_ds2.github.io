---
title: TripAdvisor API 
---

```{r}
library(httr)
```

```{r}
mn_museum <- read_csv('Data/museums_tidy.csv') |>
  filter(ADSTATE == 'MN')
```

```{r}
API_KEY = "024CD356E7014745A5893ECA15E3FD7F"
url <- "https://api.content.tripadvisor.com/api/v1/location/search"
```

```{r}
tripAdvisorAPI <- function(name, lat, long, state, postal) {
  queryString <- list(
    language = "en",
    key = API_KEY,
    searchQuery = name,
    latLong = paste(format(lat, nsmall = 5),",",format(long, nsmall = 5),sep="")
  )
  #print(paste(format(lat, nsmall = 5),",",format(long, nsmall = 5),sep=""))
  response <- GET(url, query = queryString, add_headers(Accept = "application/json"))
  
  if (http_error(response)) {
    stop("API request failed with status code: ", status_code(response))
  }
  
  detail <- content(response, type = "application/json")
  num_results <- length(detail$data)
  if (num_results == 0) {
    return(0)
  }
  
  for (i in 1:num_results) {
    address_obj <- detail$data[[i]]$address_obj
    #print(address_obj)
    if (!is.null(address_obj$country) && !is.na(address_obj$country) && address_obj$country != "United States") {
      next
    }
    if (!is.null(address_obj$postalcode)  && substr(address_obj$postalcode, 1, 5) == postal) {
      return(detail$data[[i]]$location_id)
    }
    
    if (!is.null(address_obj$state)  && address_obj$state == state) {
      return(detail$data[[i]]$location_id)
    }
    
  }
  print("No compatible place")
  return(0)
}
```

```{r}
tripAdvisorAPI("MOBILE MUSEUM OF ART", 30.70401, -88.15462, "Alabama",36689)
```


```{r}
locations_mn <-tibble(name = mn_museum$COMMONNAME, lat = mn_museum$LATITUDE, long = mn_museum$LONGITUDE)
location_id <- double(length=length(mn_museum$COMMONNAME))
```

```{r}
for (i in 1:length(mn_museum$COMMONNAME)){
  location_id[i] <-as.numeric( tripAdvisorAPI(mn_museum$COMMONNAME[i], mn_museum$LATITUDE[i], mn_museum$LONGITUDE[i], "Minnesota",mn_museum$ADZIP5[i]))
  
}
```

```{r}
locations_mn <- locations_mn |> mutate(id_tripadvisor = location_id) |>
  filter(id_tripadvisor != 0)
```

```{r}
tripadvisor_detail <- function(location_id){
  url_detail <- paste("https://api.content.tripadvisor.com/api/v1/location/",format(location_id),"/details",sep="")

  queryString_detail <- list(
    language = "en",
    currency = "USD",
    key = API_KEY
  )
  
  response <- VERB("GET", url_detail, query = queryString_detail, content_type("application/octet-stream"), accept("application/json"))
  
  detail <- content(response, type = "application/json")
  return(detail)
}
```

```{r}
tripadvisor_reviews <- vector(length=length(locations_mn))
phone_num <- vector(length=length(locations_mn))
website <- vector(length=length(locations_mn))
writing_review <- vector(length=length(locations_mn)) 
ranking_string <- vector(length=length(locations_mn))
rating <- vector(length=length(locations_mn))
rating_count <- vector(length=length(locations_mn))
open_hour <- vector(length=length(locations_mn))

```

```{r}
for (i in 1:3){
  tripadvisor_content <- tripadvisor_detail(locations_mn$id_tripadvisor[[i]])
  #web url
  tripadvisor_web[[i]] <- tripadvisor_content$web_url
  #phone number
  phone_num[[i]] <- tripadvisor_content$phone
  #writing reviews
  writing_review[[i]] <- tripadvisor_content$write_review
  #ranking string
  ranking_string[[i]] <- tripadvisor_content$review_rating_count
  #rating
  rating[[i]] <- tripadvisor_content$rating
  
  
  
}
```







